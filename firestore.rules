rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Authenticated users only - guests use session storage
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId
        && validateUserProfile();
      
      // User's card sets - SINGLE DOCUMENT PATTERN ONLY
      // Each cardSet document contains all cards in a single 'cards' array field
      // Document structure: { cardSetId, cards: [], totalCards, createdAt, updatedAt }
      // This reduces Firestore operations from N reads/writes to 1 read/write
      match /cardSets/{cardSetId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow write: if request.auth != null && request.auth.uid == userId
          && validateSingleDocumentCardSet();
        allow delete: if request.auth != null && request.auth.uid == userId;
      }
    }
  }

  // Validation for user profile structure
  function validateUserProfile() {
    // Allow reads or validate user profile structure for writes
    return !('resource' in request) || (
      // Required fields
      request.resource.data.keys().hasAll(['uid', 'isActive', 'createdAt', 'updatedAt', 'lastLoginAt']) &&
      request.resource.data.uid is string &&
      request.resource.data.isActive is bool &&
      // Optional fields validation
      (!('email' in request.resource.data) || request.resource.data.email == null || request.resource.data.email is string) &&
      (!('displayName' in request.resource.data) || request.resource.data.displayName == null || request.resource.data.displayName is string) &&
      (!('photoURL' in request.resource.data) || request.resource.data.photoURL == null || request.resource.data.photoURL is string) &&
      (!('preferredLanguage' in request.resource.data) || request.resource.data.preferredLanguage is string) &&
      (!('theme' in request.resource.data) || request.resource.data.theme in ['light', 'dark', 'system']) &&
      (!('reviewSessionSize' in request.resource.data) || request.resource.data.reviewSessionSize is number) &&
      // cardSetsProgress must be an object if present
      (!('cardSetsProgress' in request.resource.data) || (
        request.resource.data.cardSetsProgress is map &&
        validateCardSetsProgressObject(request.resource.data.cardSetsProgress)
      ))
    );
  }

  // Validate cardSetsProgress object structure
  function validateCardSetsProgressObject(progressObject) {
    // Allow empty objects or validate progress items
    return progressObject.size() == 0 || (
      progressObject.size() > 0 &&
      // Check that values in the object are valid progress items
      // Since we can't easily iterate in Firestore rules, we'll do basic validation
      // The individual progress items will be validated when accessed
      true
    );
  }

  // Validate individual progress item structure
  function validateProgressItem(progress) {
    return progress.keys().hasAll(['cardSetId', 'totalCards', 'reviewedCards', 'progressPercentage', 'createdAt', 'updatedAt']) &&
           progress.cardSetId is string &&
           progress.totalCards is number &&
           progress.reviewedCards is number &&
           progress.progressPercentage is number &&
           progress.totalCards >= 0 &&
           progress.reviewedCards >= 0 &&
           progress.progressPercentage >= 0 &&
           progress.progressPercentage <= 100 &&
           progress.reviewedCards <= progress.totalCards;
  }

  // Validation for single document card set pattern
  function validateSingleDocumentCardSet() {
    // Allow if no resource data (for reads) or if structure is valid
    return !('resource' in request) || (
      request.resource.data.keys().hasAll(['cardSetId', 'cards', 'totalCards', 'updatedAt']) &&
      request.resource.data.cardSetId is string &&
      request.resource.data.cards is list &&
      request.resource.data.totalCards is number &&
      request.resource.data.totalCards >= 0 &&
      request.resource.data.totalCards == request.resource.data.cards.size() &&
      // Ensure each card in the array has required fields
      validateCardsArray(request.resource.data.cards)
    );
  }
  
  // Validate cards array structure
  function validateCardsArray(cards) {
    // Allow empty arrays or validate each card has basic required fields
    return cards.size() == 0 || (
      cards.size() > 0 &&
      // Check first few cards for performance (Firestore limits validation complexity)
      (cards.size() <= 3 || validateCardStructure(cards[0])) &&
      (cards.size() <= 1 || validateCardStructure(cards[1])) &&
      (cards.size() <= 2 || validateCardStructure(cards[2]))
    );
  }
  
  // Validate individual card structure
  function validateCardStructure(card) {
    return card.keys().hasAll(['id', 'cardSetId']) &&
           card.id is string &&
           card.cardSetId is string;
  }
  
}
