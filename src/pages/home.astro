---
import Layout from '../layouts/Layout-web.astro';
import { getLangFromUrl, useTranslations } from '../utils/i18n';

// Import home components
import LanguageSwitcher from '../components/home/LanguageSwitcher.astro';
import HeroSection from '../components/home/HeroSection.astro';
import ProblemSection from '../components/home/ProblemSection.astro';
import HowItWorksSection from '../components/home/HowItWorksSection.astro';
import DecksSection from '../components/home/DecksSection.astro';
import BenefitsSection from '../components/home/BenefitsSection.astro';
import FeedbackBubble from '../components/home/FeedbackBubble.astro';

// Import Privacy Notice component
import PrivacyNotice from '../components/common/PrivacyNotice.tsx';

// Get current language
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Page title translation
const pageTitle = {
  en: 'NinjaLingo - Master Languages Like a Ninja',
  th: 'NinjaLingo - เรียนภาษาแบบนินจา',
};
---

<script>
  // Auto-detect browser language and redirect if needed (only for English default page)
  import { getPreferredLanguage } from '../utils/i18n';
  import { initializeHomeAnalytics } from '../utils/homeAnalytics';

  function detectAndRedirect() {
    // Only run on client side and for English page (no /th/ in URL)
    if (
      typeof window === 'undefined' ||
      window.location.pathname.includes('/th/')
    )
      return;

    const preferredLang = getPreferredLanguage();

    // If user prefers Thai but is on English page, redirect
    if (
      preferredLang === 'th' &&
      !window.location.pathname.startsWith('/th/')
    ) {
      window.location.href = '/th/home';
    }
  }

  function initializePage() {
    // Run language detection
    detectAndRedirect();

    // Initialize analytics with cookie consent
    initializeHomeAnalytics();
  }

  // Initialize page when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializePage);
  } else {
    // DOM is already ready
    initializePage();
  }
</script>

<style></style>

<Layout title={t('title', pageTitle)} lang={lang}>
  <main class="overflow-auto min-h-screen bg-white">
    <LanguageSwitcher currentLang={lang} />
    <HeroSection lang={lang} />
    <ProblemSection lang={lang} />
    <HowItWorksSection lang={lang} />
    <DecksSection lang={lang} />
    <BenefitsSection lang={lang} />
  </main>

  <!-- Feedback Bubble -->
  <FeedbackBubble />

  <!-- Privacy Notice Banner - Only shown on marketing pages -->
  <PrivacyNotice lang={lang} client:load />
</Layout>
